name: Update Zed Scoop
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Update Manifests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO="zed-industries/zed"
          
          # 1. Get the latest stable release tag (gh release view defaults to non-prerelease)
          VER=$(gh release view --repo $REPO --json tagName --template '{{.tagName}}' | sed 's/^v//')
          URL="https://github.com/$REPO/releases/download/v${VER}/Zed-x86_64.exe"
          VERSIONED_FILE="bucket/zed@${VER}.json"

          # 2. Skip if version already exists
          if [ -f "$VERSIONED_FILE" ]; then
            echo "Version $VER already exists. Skipping."
            exit 0
          fi

          # 3. Download and calculate hash
          curl -L -o temp.exe "$URL"
          HASH=$(sha256sum temp.exe | awk '{print $1}')
          rm temp.exe

          # 4. Update bucket/zed.json
          jq --arg ver "$VER" \
             --arg url "$URL" \
             --arg hash "$HASH" \
             '.version = $ver | .architecture."64bit".url = $url | .architecture."64bit".hash = $hash' \
             bucket/zed.json > bucket/zed.json.tmp && mv bucket/zed.json.tmp bucket/zed.json

          # 5. Create versioned copy
          cp bucket/zed.json "$VERSIONED_FILE"

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add bucket/zed.json bucket/zed@*.json
          git commit -m "Update Zed to $(jq -r .version bucket/zed.json)" || exit 0
          git push
